name: Update theme metrics (T_009)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *" # daily 12:00 KST

jobs:
  update:
    runs-on: ubuntu-latest

   steps:
  - name: Checkout
    uses: actions/checkout@v4

  - name: Set up Python
    uses: actions/setup-python@v5
    with:
      python-version: "3.11"

  - name: Install deps
    run: |
      python -m pip install --upgrade pip
      pip install pandas requests pykrx lxml

  - name: Run updater
    env:
      FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
    run: |
      python scripts/update_theme_metrics.py

  # 5) Commit & push ONLY if changed (ðŸ”¥ FIXED ORDER ðŸ”¥)
  - name: Commit & push if changed
    run: |
      set -e

      git config user.name "moneytree-bot"
      git config user.email "moneytree-bot@users.noreply.github.com"

      if git diff --quiet; then
        echo "No changes."
        exit 0
      fi

      git add data/theme/T_009.json
      git commit -m "chore: update T_009 returns & PER"

      git fetch origin main
      git rebase origin/main

      git push origin HEAD:main
